<!-- C -->
# Misocaにおけるビジュアルテストへの取り組み

デザインの自動テストの話

- CSSの問題検知は難しい

なぜ気づけないか

- feature specはDOM構造を検査するものでない
  - デザイン崩れはほぼ検知できない

ここでビジュアルテスト

- 正確には visual regression testing
- スクショなどを撮ったりしてdiffが取れる

## ビジュアルテストの概要

1. 外観のキャプチャ
2. 正答画像の取得
3. 画像の比較・レポート

### キャプチャ?

- テストしたい単位で描画
  - Pro: コンポーネント単位で差分とったりできる etc.
  - Con: 実際の描画単位と差がある
  - Con: Railsのpartial viewでは工夫が必要
- 一時サーバでキャプチャ
  - Pro: E2Eに組み込みやすい(かもしれない) etc.
  - Con: ↑より重い
  - Con: ランダム要素があると難しい
- 実環境でキャプチャ
  - Pro: 導入しやすい・直接確認できる
  - Con: 実データの用意などが必要
  - Con: 時間経過などで見た目が変わると使えない(日付など)

### 正答画像?

- 画像を別途保存
  - Con: 更新が必要
- 前回のキャプチャと比較
  - Pro: 正答が最新になる
  - Con: 差分を見逃すと、次回以降検知できない
- 分岐元と比較(Git)
  - Pro: PR単位で差分を確認できる
  - Con: 運用環境でのテストでは使えない
  - Con: Gitの分岐元判定は難しい

### 比較・レポート?

- diffツール次第
- 許容誤差パラメータが重要

### ツール

- reg-suit
  - 現在の外観画像は別途用意...
- BackstopJS
  - 外観の取得から比較まで
  - 実環境へのWEBアクセス + データの明治のみ
- Storybook
  - コンポーネント単位でのレンダリング

*適切に選ぼうね*

## どう扱っているか

### 本番環境

- 前日との差分を検知
  - capybara-screenshot
  - reg-suit
- Slackへ通知

### ステージ環境

- リリースごとにやる(本番環境と内容は同じ)

### ローカル環境

- 必要な時に
  - BackstopJS
  - masterでinit
- ローカルで表示しづらい画面がある(外部連携)
- 環境(OS)による差異もある
<!-- - CSSを書く人がJSに慣れてた -->

### 帳票

- Minimagicでpdf→png
- CI上でapprove commit

## 運用の工夫・注意点(visual test)

- CSSのアニメーションやキャレット(点滅するやつ)はなくす
  - タイミングによって差分が変わってしまう
- 非同期読み込みは長めに待つ
  - 画像など
- 出力される画像名をちゃんとつける
  - ルールを定めるようなヘルパーを作ればOK?

### どのくらいテスト書くか

- (時間がかかるので)コーナーケースを実行しすぎない
  - 重要・典型的なケースのみ
- 1画面で複数の状態をテストする

### 誤差の許容

- False Positive(差異を誤検知)
  - これが増えると辛い(数pxのdiffが生まれてしまう)
  - アプリによって適宜変更すべき
- False Negative(差異を見直す)

- 差分検知時に「どう作業するか」のフローを決めるのも大事

## 夢

- 表示データを揃えたい
- rrrspecで
- 全部Vue.js化...
- partial単位で画像を作る

## まとめ

- 導入してよかった
  - CSSののリファクタ(での失敗)に気づけた
  - いちいちページ開いて確認する必要がなくなった
